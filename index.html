<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Haftalık Saha Ziyaret Raporu</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root{--m:#0b2a55;--a:#1e88e5;--b:#ddd;--bg:#f4f6f8}
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:var(--bg)}
header{background:var(--m);color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:bold}
.container{max-width:1000px;margin:auto;padding:12px}
.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px}
.info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--b)}
.tabs{display:flex;gap:6px;margin:10px 0}
.tabs button{flex:1;padding:10px;border:none;border-radius:10px;background:#ccc;font-weight:bold}
.tabs button.active{background:var(--a);color:#fff}
.visit{border:1px solid var(--b);border-radius:10px;padding:10px;margin-bottom:8px}
.visit b{display:block;margin-bottom:6px}
.actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
button{padding:14px;border:none;border-radius:14px;font-size:15px;color:#fff}
.save{background:#43a047}
.pdf{background:#e53935}
.reset{background:#546e7a}
.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;text-align:center}
.summary div{background:#e3f2fd;padding:10px;border-radius:10px}
@media(max-width:600px){.summary{grid-template-columns:1fr 1fr}}

/* PDF */
@media print{
 body{background:#fff}
 header,.actions,.tabs{display:none}
 .container{max-width:none;padding:0}
 .card{border-radius:0}
 .page{page-break-after:always}
 table{width:100%;border-collapse:collapse;font-size:11px}
 th,td{border:1px solid #000;padding:4px;text-align:left}
}
</style>
</head>
<body>
<header>HAFTALIK SAHA ZİYARET RAPORU</header>
<div class="container" id="app">

<div class="card info">
<select id="personel"></select>
<input id="bolge" placeholder="Bölge / Şehir">
<input id="tarih" placeholder="Hafta">
<input id="plaka" placeholder="Araç Plaka">
<input id="kmBas" type="number" placeholder="Başlangıç KM">
<input id="kmBit" type="number" placeholder="Bitiş KM">
</div>

<div class="tabs" id="tabs"></div>
<div id="days"></div>

<div class="card" id="yoneticiOzet">
<h3 style="text-align:center">YÖNETİCİ ÖZET RAPORU</h3>
<table>
<tr><th>Personel</th><th>Bölge</th><th>Hafta</th><th>Plaka</th><th>Toplam Ziyaret</th><th>Numune</th><th>Katalog</th><th>KM</th></tr>
<tr>
<td id="pO"></td><td id="bO"></td><td id="tO"></td><td id="plO"></td>
<td id="ozZ"></td><td id="ozN"></td><td id="ozK"></td><td id="ozKM"></td>
</tr>
</table>
</div>

<div class="actions">
<button class="save" onclick="saveData()">Kaydet</button>
<button class="pdf" onclick="exportPDF()">PDF Oluştur</button>
<button class="reset" onclick="newWeek()">Yeni Hafta</button>
</div>
</div>

<script>
const KEY='haftalik_ziyaret_stabil';
const personeller=['Hasret Gökot','Ömür Kaplan','Gamze Kaç','Işıl Engin'];
const gunler=['Pazartesi','Salı','Çarşamba','Perşembe','Cuma'];
const ziyaretAdet=15;

const pSel=document.getElementById('personel');
pSel.innerHTML=personeller.map(p=>'<option>'+p+'</option>').join('');

const tabs=document.getElementById('tabs');
const days=document.getElementById('days');

gunler.forEach((g,di)=>{
 tabs.innerHTML+='<button onclick="openDay('+di+')" '+(di===0?'class=active':'')+'>'+g.substring(0,3).toUpperCase()+'</button>';
 let h='<div class="day" style="display:'+(di===0?'block':'none')+'"><div class="card"><h3>'+g+'</h3><table><tr><th>#</th><th>Saat</th><th>Firma</th><th>Telefon</th><th>E‑Mail</th><th>Amaç</th><th>N</th><th>K</th></tr>';
 for(let i=1;i<=ziyaretAdet;i++){
  h+='<tr class="vrow" data-di="'+di+'" data-i="'+i+'">'
    +'<td>'+i+'</td>'
    +'<td><input type="time" data-k="d'+di+'v'+i+'_time"></td>'
    +'<td><input data-k="d'+di+'v'+i+'_firma"></td>'
    +'<td><input data-k="d'+di+'v'+i+'_telefon"></td>'
    +'<td><input data-k="d'+di+'v'+i+'_mail"></td>'
    +'<td><select data-k="d'+di+'v'+i+'_amac"><option></option><option>Tanışma</option><option>Tekrar</option><option>İade</option><option>Tanıtım</option></select></td>'
    +'<td><input type="checkbox" data-k="d'+di+'v'+i+'_numune"></td>'
    +'<td><input type="checkbox" data-k="d'+di+'v'+i+'_katalog"></td>'
    +'</tr>';
 }
 h+='</table></div></div>';
 days.innerHTML+=h;
});

function openDay(i){
 document.querySelectorAll('.tabs button').forEach((b,bi)=>b.classList.toggle('active',bi===i));
 document.querySelectorAll('.day').forEach((d,di)=>d.style.display=di===i?'block':'none');
}

function saveData(){
 const d={meta:{personel:pSel.value,bolge:bolge.value,tarih:tarih.value,plaka:plaka.value,kmBas:kmBas.value,kmBit:kmBit.value},v:{}};
 document.querySelectorAll('[data-k]').forEach(e=>d.v[e.dataset.k]=e.type==='checkbox'?e.checked:e.value);
 localStorage.setItem(KEY,JSON.stringify(d));
 calcSummary(d);
}

function calcSummary(d){
 let z=0,n=0,k=0;
 Object.keys(d.v).forEach(x=>{
  if(x.endsWith('firma')&&d.v[x]) z++;
  if(x.endsWith('numune')&&d.v[x]) n++;
  if(x.endsWith('katalog')&&d.v[x]) k++;
 });
 ozZ.innerText=z; ozN.innerText=n; ozK.innerText=k;
 ozKM.innerText=(d.meta.kmBit-d.meta.kmBas)||0;
 pO.innerText=d.meta.personel; bO.innerText=d.meta.bolge; tO.innerText=d.meta.tarih; plO.innerText=d.meta.plaka;
}

function exportPDF(){
 saveData();
 const data=JSON.parse(localStorage.getItem(KEY));
 if(!data) return;
 // RAPOR ALANI
 let html=`<div id="pdfReport" style="font-family:Arial;padding:10px">`;
 // SAYFA 1 OZET
 html+=`<h2 style="text-align:center">HAFTALIK YÖNETİCİ ÖZETİ</h2>`;
 html+=`<table style="width:100%;border-collapse:collapse;font-size:12px">`;
 html+=`<tr><td><b>Personel</b></td><td>${data.meta.personel||''}</td><td><b>Bölge</b></td><td>${data.meta.bolge||''}</td></tr>`;
 html+=`<tr><td><b>Hafta</b></td><td>${data.meta.tarih||''}</td><td><b>Araç</b></td><td>${data.meta.plaka||''}</td></tr>`;
 html+=`<tr><td><b>Toplam Ziyaret</b></td><td>${ozZ.innerText}</td><td><b>KM</b></td><td>${ozKM.innerText}</td></tr>`;
 html+=`</table><div style="page-break-after:always"></div>`;
 // SAYFA 2+ TABLO
 html+=`<h2 style="text-align:center">HAFTALIK ZİYARET DETAYI</h2>`;
 html+=`<table border="1" style="width:100%;border-collapse:collapse;font-size:11px">`;
 html+=`<tr><th>Gün</th><th>Saat</th><th>Firma</th><th>Telefon</th><th>E‑Mail</th><th>Amaç</th><th>Numune</th><th>Katalog</th></tr>`;
 gunler.forEach((g,di)=>{
  for(let i=1;i<=ziyaretAdet;i++){
   const f=data.v[`d${di}v${i}_firma`];
   if(!f) continue;
   html+=`<tr>`+
   `<td>${g}</td>`+
   `<td>${data.v[`d${di}v${i}_time`]||''}</td>`+
   `<td>${f}</td><td>${data.v[`d${di}v${i}_telefon`]||''}</td><td>${data.v[`d${di}v${i}_mail`]||''}</td>`+
   `<td>${data.v[`d${di}v${i}_amac`]||''}</td>`+
   `<td>${data.v[`d${di}v${i}_numune`]?'✔':''}</td>`+
   `<td>${data.v[`d${di}v${i}_katalog`]?'✔':''}</td>`+
   `</tr>`;
  }
 });
 html+=`</table></div>`;
 const w=window.open('','','width=900,height=700');
 w.document.write(`<html><head><title>Rapor</title></head><body>${html}</body></html>`);
 w.document.close();
 w.focus();
 w.print();
}
function newWeek(){ if(confirm('Silinsin mi?')){localStorage.removeItem(KEY);location.reload();} }

(function load(){ const d=JSON.parse(localStorage.getItem(KEY)); if(!d) return;
 Object.keys(d.meta).forEach(k=>document.getElementById(k).value=d.meta[k]);
 document.querySelectorAll('[data-k]').forEach(e=>{ if(d.v[e.dataset.k]!=null){e.type==='checkbox'?e.checked=d.v[e.dataset.k]:e.value=d.v[e.dataset.k];}});
 calcSummary(d);
})();
</script>
</body>
</html>
