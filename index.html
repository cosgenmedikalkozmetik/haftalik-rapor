<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Haftalık Saha Ziyaret Raporu</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root{--m:#0b2a55;--a:#1e88e5;--b:#ddd;--bg:#f4f6f8}
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:var(--bg)}
header{background:var(--m);color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:bold}
.container{max-width:1000px;margin:auto;padding:12px}
.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px}
.info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--b)}
.tabs{display:flex;gap:6px;margin:10px 0}
.tabs button{flex:1;padding:10px;border:none;border-radius:10px;background:#ccc;font-weight:bold}
.tabs button.active{background:var(--a);color:#fff}
.visit{border:1px solid var(--b);border-radius:10px;padding:10px;margin-bottom:8px}
.visit b{display:block;margin-bottom:6px}
.actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
button{padding:14px;border:none;border-radius:14px;font-size:15px;color:#fff}
.save{background:#43a047}
.pdf{background:#e53935}
.reset{background:#546e7a}
.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;text-align:center}
.summary div{background:#e3f2fd;padding:10px;border-radius:10px}
@media(max-width:600px){.summary{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header>HAFTALIK SAHA ZİYARET RAPORU</header>
<div class="container" id="app">

<div class="card info">
<select id="personel"></select>
<input id="bolge" placeholder="Bölge / Şehir">
<input id="tarih" placeholder="Hafta (01-05 Oca 2026)">
<input id="plaka" placeholder="Araç Plaka">
<input id="kmBas" type="number" placeholder="Başlangıç KM">
<input id="kmBit" type="number" placeholder="Bitiş KM">
</div>

<div class="tabs" id="tabs"></div>
<div id="days"></div>

<div class="card">
<h3 style="margin-top:0;text-align:center">HAFTALIK YÖNETİCİ ÖZETİ</h3>
<div class="summary">
<div><b>Ziyaret</b><br><span id="ozZ">0</span></div>
<div><b>Numune</b><br><span id="ozN">0</span></div>
<div><b>Katalog</b><br><span id="ozK">0</span></div>
<div><b>KM</b><br><span id="ozKM">0</span></div>
</div>
</div>

<div class="actions">
<button class="save" onclick="saveData()">Kaydet</button>
<button class="pdf" onclick="exportPDF()">PDF Oluştur</button>
<button class="reset" onclick="newWeek()">Yeni Hafta</button>
</div>
</div>

<script>
const KEY='haftalik_ziyaret_stabil';
const personeller=['Hasret Gökot','Ömür Kaplan','Gamze Kaç','Işıl Engin'];
const gunler=['Pazartesi','Salı','Çarşamba','Perşembe','Cuma'];
const ziyaretAdet=15;

const pSel=document.getElementById('personel');
pSel.innerHTML=personeller.map(p=>`<option>${p}</option>`).join('');

const tabs=document.getElementById('tabs');
const days=document.getElementById('days');

gunler.forEach((g,di)=>{
 tabs.innerHTML+=`<button onclick="openDay(${di})" ${di===0?'class=active':''}>${g.substring(0,3).toUpperCase()}</button>`;
 let h=`<div class="day" style="display:${di===0?'block':'none'}"><div class="card"><h3>${g}</h3>`;
 for(let i=1;i<=ziyaretAdet;i++){
  h+=`<div class="visit">
   <b>${i}. Ziyaret</b>
   <input type="time" data-k="d${di}v${i}_time">
   <input placeholder="Firma / Cari" data-k="d${di}v${i}_firma">
   <select data-k="d${di}v${i}_amac">
    <option value="">Amaç</option>
    <option>Tanışma</option>
    <option>Tekrar Ziyaret</option>
    <option>İade</option>
    <option>Ürün Tanıtımı</option>
   </select>
   <label><input type="checkbox" data-k="d${di}v${i}_numune"> Numune</label>
   <label><input type="checkbox" data-k="d${di}v${i}_katalog"> Katalog</label>
  </div>`;
 }
 h+='</div></div>';
 days.innerHTML+=h;
});

function openDay(i){
 document.querySelectorAll('.tabs button').forEach((b,bi)=>b.classList.toggle('active',bi===i));
 document.querySelectorAll('.day').forEach((d,di)=>d.style.display=di===i?'block':'none');
}

function saveData(){
 const data={meta:{personel:pSel.value,bolge:bolge.value,tarih:tarih.value,plaka:plaka.value,kmBas:kmBas.value,kmBit:kmBit.value},v:{}};
 document.querySelectorAll('[data-k]').forEach(e=>data.v[e.dataset.k]=e.type==='checkbox'?e.checked:e.value);
 localStorage.setItem(KEY,JSON.stringify(data));
 calcSummary(data);
 alert('Kaydedildi');
}

function loadData(){
 const d=JSON.parse(localStorage.getItem(KEY)); if(!d) return;
 Object.keys(d.meta).forEach(k=>document.getElementById(k).value=d.meta[k]);
 document.querySelectorAll('[data-k]').forEach(e=>{if(d.v[e.dataset.k]!=null) e.type==='checkbox'?e.checked=d.v[e.dataset.k]:e.value=d.v[e.dataset.k]});
 calcSummary(d);
}

function calcSummary(d){
 let z=0,n=0,k=0;
 Object.keys(d.v).forEach(x=>{
  if(x.endsWith('firma')&&d.v[x]) z++;
  if(x.endsWith('numune')&&d.v[x]) n++;
  if(x.endsWith('katalog')&&d.v[x]) k++;
 });
 ozZ.innerText=z; ozN.innerText=n; ozK.innerText=k;
 ozKM.innerText=(d.meta.kmBit-d.meta.kmBas)||0;
}

function exportPDF(){
 const d=JSON.parse(localStorage.getItem(KEY));
 if(!d){alert('Kayıt yok');return;}

 let pages='';
 gunler.forEach((g,di)=>{
  let rows='';
  for(let i=1;i<=ziyaretAdet;i++){
   const f=d.v[`d${di}v${i}_firma`];
   if(!f) continue;
   rows+=`<tr>
     <td>${d.v[`d${di}v${i}_time`]||''}</td>
     <td>${f}</td>
     <td>${d.v[`d${di}v${i}_amac`]||''}</td>
     <td style="text-align:center">${d.v[`d${di}v${i}_numune`]?'✔':''}</td>
     <td style="text-align:center">${d.v[`d${di}v${i}_katalog`]?'✔':''}</td>
   </tr>`;
  }
  if(rows){
   pages+=`<div class="pdfPage">
    <h2>${g}</h2>
    <div class="meta">${d.meta.personel} | ${d.meta.bolge} | ${d.meta.tarih} | Plaka: ${d.meta.plaka}</div>
    <table>
     <thead><tr><th>Saat</th><th>Firma</th><th>Amaç</th><th>Numune</th><th>Katalog</th></tr></thead>
     <tbody>${rows}</tbody>
    </table>
   </div>`;
  }
 });

 if(!pages){alert('PDF için dolu ziyaret yok');return;}

 // PDF alanını GERÇEKTEN ekrana ekle (kritik)
 const pdfRoot=document.createElement('div');
 pdfRoot.id='pdfRoot';
 pdfRoot.innerHTML=`<style>
  #pdfRoot{background:#fff;color:#000;width:210mm;padding:12mm}
  .pdfPage{page-break-after:always;font-family:Arial}
  .pdfPage h2{text-align:center;margin:0 0 6px 0}
  .meta{text-align:center;font-size:12px;margin-bottom:8px}
  table{width:100%;border-collapse:collapse;font-size:11px}
  th,td{border:1px solid #000;padding:4px}
 </style>${pages}`;

 document.body.appendChild(pdfRoot);

 // Render garanti bekleme
 setTimeout(()=>{
  html2pdf()
   .set({
     filename:'haftalik_ziyaret_raporu.pdf',
     jsPDF:{format:'a4',orientation:'portrait'},
     html2canvas:{scale:2}
   })
   .from(pdfRoot)
   .save()
   .then(()=>document.body.removeChild(pdfRoot));
 },500);
}

function newWeek(){ if(confirm('Tüm veriler silinecek. Emin misiniz?')){localStorage.removeItem(KEY);location.reload();} }

loadData();
</script>
</body>
</html>
